<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>SmartHomeHub — Панель</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#2563eb; --danger:#ef4444; --ok:#22c55e; }
        html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
        .container{max-width:1200px;margin:24px auto;padding:0 16px;}
        .row{display:flex;gap:16px;flex-wrap:wrap;}
        .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25);}
        h1{font-size:22px;margin:0 0 16px;}
        h2{font-size:18px;margin:0 0 12px;}
        .muted{color:var(--muted)}
        .grid{display:grid;gap:12px;}
        .grid.cols-2{grid-template-columns:1fr 1fr}
        label{font-size:12px;color:var(--muted)}
        input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--txt);outline:none}
        .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;transition:.15s;background .15s,opacity .15s}
        .btn-primary{background:var(--accent);color:white}
        .btn-ghost{background:transparent;color:var(--txt);border:1px solid #334155}
        .btn-danger{background:var(--danger);color:white}
        .btn-ok{background:var(--ok);color:black}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left;font-size:14px}
        .chip{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #334155}
        .switch{appearance:none;width:42px;height:24px;border-radius:999px;background:#334155;position:relative;cursor:pointer}
        .switch:checked{background:var(--ok)}
        .switch:before{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:white;transition:.15s left}
        .switch:checked:before{left:21px}
        .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
        .status-on{background:var(--ok)}
        .status-off{background:var(--danger)}
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="card" style="flex:1 1 320px">
            <h1>SmartHomeHub</h1>
            <div class="muted">Управление устройствами и службами NanoPi</div>
            <div id="auth" style="margin-top:12px">
                <input id="user" placeholder="Логин (admin)">
                <input id="pass" placeholder="Пароль (admin)" type="password">
                <button class="btn btn-ghost" onclick="saveAuth()">Сохранить</button>
                <button class="btn btn-ghost" onclick="clearAuth()">Сбросить</button>
            </div>
        </div>

        <div class="card" style="flex:1 1 380px">
            <h2>Добавить устройство</h2>
            <div class="grid cols-2">
                <div><label>Имя</label><input id="f_name"></div>
                <div><label>Тип</label>
                    <select id="f_type"><option value="LIGHT">LIGHT</option><option value="SWITCH">SWITCH</option></select>
                </div>
                <div class="grid" style="grid-column:1/-1"><label>MQTT Topic</label><input id="f_topic"></div>
                <div><label>Online</label><input id="f_online" type="checkbox" class="switch" checked></div>
                <div><label>On</label><input id="f_on" type="checkbox" class="switch"></div>
            </div>
            <button class="btn btn-primary" onclick="createDevice()" style="margin-top:10px">Добавить</button>
        </div>
    </div>

    <div class="card" style="margin-top:16px">
        <div class="toolbar"><h2>Устройства</h2><button class="btn btn-ghost" onclick="loadDevices()">Обновить</button></div>
        <table id="tbl"><thead><tr><th>ID</th><th>Имя</th><th>Тип</th><th>Топик</th><th>Online</th><th>On</th><th>Действия</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card" style="margin-top:16px">
        <h2>Службы NanoPi</h2>
        <div>
            <button class="btn btn-ghost" onclick="service('zapret','restart')">Перезапустить zapret</button>
            <button class="btn btn-ghost" onclick="service('xray','restart')">Перезапустить xray</button>
            <button class="btn btn-ghost" onclick="service('mosquitto','restart')">Перезапустить mosquitto</button>
        </div>
        <div id="svc_status" class="muted" style="margin-top:6px"></div>
    </div>
</div>

<script>
    const LS_KEY='smh_auth';
    function getAuth(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}catch{return{}}}
    function setAuth(a){localStorage.setItem(LS_KEY,JSON.stringify(a||{}))}
    function clearAuth(){localStorage.removeItem(LS_KEY);alert('Сброшены')}
    function saveAuth(){setAuth({u:user.value||'admin',p:pass.value||'admin'});alert('Сохранено')}
    function authHeader(){const {u,p}=getAuth();return u&&p?{'Authorization':'Basic '+btoa(u+':'+p)}:{}}

    async function api(path,opt={}) {
      const resp=await fetch(path,{...opt,headers:{...(opt.body?{'Content-Type':'application/json'}:{}),...authHeader()}});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      return resp.json().catch(()=>null);
    }

    async function loadDevices(){
      const data=await api('/api/devices');
      const tb=document.querySelector('#tbl tbody');tb.innerHTML='';
      for(const d of data){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${d.id}</td><td>${d.name}</td><td>${d.type}</td>
          <td>${d.topic}</td>
          <td><span class="status-dot ${d.online?'status-on':'status-off'}"></span>${d.online?'Online':'Offline'}</td>
          <td><input type="checkbox" ${d.onState?'checked':''} onchange="setState(${d.id},this.checked)" class="switch"></td>
          <td><button class="btn btn-ghost" onclick="toggleDevice(${d.id})">Toggle</button>
          <button class="btn btn-danger" onclick="delDevice(${d.id})">Удалить</button></td>`;
        tb.appendChild(tr);
      }
    }

    async function createDevice(){
      await api('/api/devices',{method:'POST',body:JSON.stringify({name:f_name.value,type:f_type.value,topic:f_topic.value,online:f_online.checked,onState:f_on.checked})});
      loadDevices();
    }
    async function toggleDevice(id){await api('/api/devices/'+id+'/toggle',{method:'POST'});loadDevices()}
    async function setState(id,on){await api('/api/devices/'+id+'/state?on='+on,{method:'POST'})}
    async function delDevice(id){await api('/api/devices/'+id,{method:'DELETE'});loadDevices()}

    async function service(name,action){
      const s=document.getElementById('svc_status');s.textContent='...';
      try{const r=await api('/api/system/'+name+'/'+action,{method:'POST'});s.textContent='OK: '+name+' '+action}
      catch(e){s.textContent='Ошибка: '+e.message}
    }

    loadDevices();
</script>
</body>
</html>